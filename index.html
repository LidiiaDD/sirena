<!DOCTYPE html>
<html lang="uk" data-theme="dark">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Voice â†’ Translate â†’ Word</title>
<link rel="preconnect" href="https://unpkg.com">
<style>
  :root{
    --bg:#0b1020; --text:#e5e7eb; --muted:#94a3b8;
    --panel:#0f172a; --card:#111827; --line:rgba(255,255,255,.08);
    --btn:#1f2937; --primary:#2563eb; --danger:#ef4444; --accent:#22c55e;
    --pane-text:#e5e7eb; --pane-alt:#eef9ff;
  }
  [data-theme="light"]{
    --bg:#f8fafc; --text:#0f172a; --muted:#475569;
    --panel:#ffffff; --card:#ffffff; --line:rgba(0,0,0,.1);
    --btn:#e2e8f0; --primary:#2563eb; --danger:#ef4444; --accent:#16a34a;
    --pane-text:#0f172a; --pane-alt:#e6f4ff;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
  .wrap{max-width:1100px;margin:32px auto;padding:0 16px}
  .bar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:16px}
  .btn{appearance:none;border:0;border-radius:12px;padding:12px 16px;background:var(--btn);color:var(--text);cursor:pointer}
  .btn:hover{filter:brightness(1.05)} .btn:disabled{opacity:.5;cursor:not-allowed}
  .btn.primary{background:var(--primary);color:#fff} .btn.stop{background:var(--danger);color:#fff}
  .btn.ghost{background:transparent;border:1px solid var(--line)}
  .select{padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:var(--panel);color:var(--text)}
  .pane{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:14px}
  textarea{width:100%;min-height:200px;background:transparent;border:0;color:var(--pane-text);resize:vertical;font-size:15px;line-height:1.5}
  h1{font-size:22px;margin:0 0 14px 0} h2{font-size:16px;margin:10px 0}
  .status{margin-top:6px;font-size:13px;color:var(--muted)}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:20px;background:var(--panel);border:1px solid var(--line);font-size:12px}
  .ok{color:var(--accent)} .bad{color:var(--danger)}
  .spacer{flex:1}
</style>
</head>
<body>
<div class="wrap">
  <h1>ğŸ™ï¸ Voice â†’ ğŸŒ Translate â†’ ğŸ“„ Word</h1>

  <div class="bar">
    <button id="startBtn" class="btn primary" aria-label="ĞŸĞ¾Ñ‡Ğ°Ñ‚Ğ¸">â–¶ï¸ ĞŸĞ¾Ñ‡Ğ°Ñ‚Ğ¸</button>
    <button id="stopBtn" class="btn stop" disabled aria-label="Ğ—ÑƒĞ¿Ğ¸Ğ½Ğ¸Ñ‚Ğ¸">â¹ Ğ—ÑƒĞ¿Ğ¸Ğ½Ğ¸Ñ‚Ğ¸</button>
    <button id="clearBtn" class="btn" aria-label="ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ñ‚Ğ¸">ğŸ§¹ ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ñ‚Ğ¸</button>
    <button id="saveBtn" class="btn" aria-label="Ğ—Ğ±ĞµÑ€ĞµĞ³Ñ‚Ğ¸ Ğ² Word">ğŸ’¾ Word</button>
    <button id="copyBtn" class="btn" aria-label="ĞšĞ¾Ğ¿Ñ–ÑĞ²Ğ°Ñ‚Ğ¸ Ğ¿ĞµÑ€ĞµĞºĞ»Ğ°Ğ´">ğŸ“‹ ĞšĞ¾Ğ¿Ñ–ÑĞ²Ğ°Ñ‚Ğ¸ Ğ¿ĞµÑ€ĞµĞºĞ»Ğ°Ğ´</button>
    <button id="txtBtn" class="btn" aria-label="Ğ•ĞºÑĞ¿Ğ¾Ñ€Ñ‚ Ñƒ TXT">ğŸ—’ TXT</button>
    <span class="spacer"></span>
    <button id="themeBtn" class="btn ghost" aria-label="ĞŸĞµÑ€ĞµĞ¼ĞºĞ½ÑƒÑ‚Ğ¸ Ñ‚ĞµĞ¼Ñƒ">ğŸŒ™ Ğ¢ĞµĞ¼Ğ°</button>
  </div>

  <div class="bar">
    <label>ğŸ—£ ĞœĞ¾Ğ²Ğ° Ğ´Ğ¸ĞºÑ‚Ğ¾Ñ€Ğ°:
      <select id="sourceLang" class="select">
        <option value="uk-UA">uk-UA (Ğ£ĞºÑ€Ğ°Ñ—Ğ½ÑÑŒĞºĞ°)</option>
        <option value="ru-RU">ru-RU (Ğ ÑƒÑÑĞºĞ¸Ğ¹)</option>
        <option value="en-US">en-US (English)</option>
        <option value="pl-PL">pl-PL (Polski)</option>
        <option value="de-DE">de-DE (Deutsch)</option>
        <option value="fr-FR">fr-FR (FranÃ§ais)</option>
      </select>
    </label>
    <label>ğŸ”½ ĞœĞ¾Ğ²Ğ° Ğ¿ĞµÑ€ĞµĞºĞ»Ğ°Ğ´Ñƒ:
      <select id="targetLang" class="select">
        <option value="uk">uk</option>
        <option value="en">en</option>
        <option value="pl">pl</option>
        <option value="de">de</option>
        <option value="fr">fr</option>
        <option value="es">es</option>
      </select>
    </label>
    <span class="pill" id="asrSupport">ASR: â€¦</span>
    <span class="pill" id="transSupport">Translate: â€¦</span>
  </div>

  <div class="pane">
    <h2>ğŸ¤ ĞÑ€Ğ¸Ğ³Ñ–Ğ½Ğ°Ğ»ÑŒĞ½Ğ¸Ğ¹ Ñ‚ĞµĞºÑÑ‚</h2>
    <textarea id="orig" placeholder="Ğ¢ÑƒÑ‚ Ğ·â€™ÑĞ²Ğ»ÑÑ‚Ğ¸Ğ¼ĞµÑ‚ÑŒÑÑ Ñ€Ğ¾Ğ·Ğ¿Ñ–Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹ Ñ‚ĞµĞºÑÑ‚â€¦"></textarea>
  </div>

  <div class="pane" style="margin-top:14px;">
    <h2>ğŸŒ ĞŸĞµÑ€ĞµĞºĞ»Ğ°Ğ´</h2>
    <textarea id="tran" placeholder="Ğ¢ÑƒÑ‚ Ğ·â€™ÑĞ²Ğ»ÑÑ‚Ğ¸Ğ¼ĞµÑ‚ÑŒÑÑ Ğ¿ĞµÑ€ĞµĞºĞ»Ğ°Ğ´â€¦"></textarea>
    <div class="status" id="status">Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾ Ğ´Ğ¾ Ñ€Ğ¾Ğ±Ğ¾Ñ‚Ğ¸</div>
  </div>
</div>

<!-- docx + filesaver -->
<script src="https://unpkg.com/docx@8.5.0/build/index.umd.js"></script>
<script src="https://unpkg.com/file-saver@2.0.5/dist/FileSaver.min.js"></script>
<script>
(() => {
  // ====== CONFIG: Ğ¿ĞµÑ€ĞµĞºĞ»Ğ°Ğ´ ======
  // âš¡ Ğ Ğ•ĞšĞĞœĞ•ĞĞ”ĞĞ’ĞĞĞ: Ğ²ÑÑ‚Ğ°Ğ² ÑĞ²Ñ–Ğ¹ ĞºĞ»ÑÑ‡ Ñ– Ñ€ĞµĞ³Ñ–Ğ¾Ğ½ Azure â€” Ğ¿ĞµÑ€ĞµĞºĞ»Ğ°Ğ´ ÑÑ‚Ğ°Ğ½Ğµ Ğ¼Ğ¸Ñ‚Ñ‚Ñ”Ğ²Ğ¸Ğ¼ Ñ– ÑÑ‚Ğ°Ğ±Ñ–Ğ»ÑŒĞ½Ğ¸Ğ¼
  const AZURE_KEY = "";        // â† Ğ²ÑÑ‚Ğ°Ğ² ĞºĞ»ÑÑ‡
  const AZURE_REGION = "";     // â† Ğ½Ğ°Ğ¿Ñ€. "westeurope"
  const AZURE_ENDPOINT = "https://api.cognitive.microsofttranslator.com/translate?api-version=3.0";

  // fallback Ğ±ĞµĞ· ĞºĞ»ÑÑ‡Ñ–Ğ²: ĞºÑ–Ğ»ÑŒĞºĞ° Ğ¿ÑƒĞ±Ğ»Ñ–Ñ‡Ğ½Ğ¸Ñ… ÑĞµÑ€Ğ²Ñ–ÑÑ–Ğ²
  const LIBRE_URLS = [
    "https://libretranslate.com/translate",
    "https://libretranslate.de/translate",
    "https://translate.astian.org/translate"
  ];
  const MYMEMORY_URL = "https://api.mymemory.translated.net/get";

  const shortLang = (code) => (code || "").split("-")[0].toLowerCase();

  // ====== Ğ•Ğ›Ğ•ĞœĞ•ĞĞ¢Ğ˜ UI ======
  const startBtn = document.getElementById("startBtn");
  const stopBtn  = document.getElementById("stopBtn");
  const clearBtn = document.getElementById("clearBtn");
  const saveBtn  = document.getElementById("saveBtn");
  const copyBtn  = document.getElementById("copyBtn");
  const txtBtn   = document.getElementById("txtBtn");
  const themeBtn = document.getElementById("themeBtn");

  const sourceSel= document.getElementById("sourceLang");
  const targetSel= document.getElementById("targetLang");
  const orig     = document.getElementById("orig");
  const tran     = document.getElementById("tran");
  const statusEl = document.getElementById("status");
  const asrBadge = document.getElementById("asrSupport");
  const trBadge  = document.getElementById("transSupport");

  // ====== Ğ¢Ğ•ĞœĞ (Ğ·Ğ±ĞµÑ€ĞµĞ¶ĞµĞ½Ğ½Ñ Ğ²Ğ¸Ğ±Ğ¾Ñ€Ñƒ) ======
  const root = document.documentElement;
  const savedTheme = localStorage.getItem("theme");
  if (savedTheme) root.setAttribute("data-theme", savedTheme);
  themeBtn.textContent = root.getAttribute("data-theme")==="dark" ? "ğŸŒ™ Ğ¢ĞµĞ¼Ğ°" : "â˜€ï¸ Ğ¢ĞµĞ¼Ğ°";
  themeBtn.addEventListener("click", () => {
    const cur = root.getAttribute("data-theme") || "dark";
    const next = cur === "dark" ? "light" : "dark";
    root.setAttribute("data-theme", next);
    localStorage.setItem("theme", next);
    themeBtn.textContent = next==="dark" ? "ğŸŒ™ Ğ¢ĞµĞ¼Ğ°" : "â˜€ï¸ Ğ¢ĞµĞ¼Ğ°";
  });

  // Ğ´ĞµÑ„Ğ¾Ğ»Ñ‚ â€” Ğ¼Ğ¾Ğ²Ğ° ÑĞ¸ÑÑ‚ĞµĞ¼Ğ¸ Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµĞºĞ»Ğ°Ğ´Ñƒ
  const sys = (navigator.language || "uk").split("-")[0];
  [...targetSel.options].some(o => { if (o.value === sys) { targetSel.value = sys; return true; } });

  // ====== ASR (Ñ€Ğ¾Ğ·Ğ¿Ñ–Ğ·Ğ½Ğ°Ğ²Ğ°Ğ½Ğ½Ñ Ğ² Ğ±Ñ€Ğ°ÑƒĞ·ĞµÑ€Ñ–) ======
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  const asrSupported = !!SR;
  asrBadge.textContent = "ASR: " + (asrSupported ? "supported" : "not available");
  asrBadge.classList.add(asrSupported ? "ok" : "bad");
  trBadge.textContent = "Translate: " + (AZURE_KEY && AZURE_REGION ? "Azure" : "Libre + backup");
  trBadge.classList.add("ok");

  // ====== ĞŸĞµÑ€ĞµĞºĞ»Ğ°Ğ´ Ğ· Ğ¿Ñ€Ñ–Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚Ğ¾Ğ¼ Azure ======
  async function translateText(text, to, from = "auto") {
    if (!text.trim()) return "";

    // 1) Azure
    if (AZURE_KEY && AZURE_REGION) {
      try {
        const url = `${AZURE_ENDPOINT}&to=${encodeURIComponent(to)}`;
        const r = await fetch(url, {
          method: "POST",
          headers: {
            "Ocp-Apim-Subscription-Key": AZURE_KEY,
            "Ocp-Apim-Subscription-Region": AZURE_REGION,
            "Content-Type": "application/json; charset=UTF-8",
          },
          body: JSON.stringify([{ Text: text }])
        });
        if (r.ok) {
          const data = await r.json();
          const t = data?.[0]?.translations?.[0]?.text;
          if (t) return t;
        } else {
          console.warn("Azure HTTP:", r.status);
        }
      } catch (e) { console.warn("Azure error:", e); }
    }

    // 2) LibreTranslate (ĞºÑ–Ğ»ÑŒĞºĞ° Ğ´Ğ·ĞµÑ€ĞºĞ°Ğ»)
    for (const url of LIBRE_URLS) {
      try {
        const r = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ q: text, source: from, target: to, format: "text" })
        });
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        const data = await r.json();
        if (data?.translatedText) return data.translatedText;
      } catch (e) {
        console.warn("Libre error:", url, e);
      }
    }

    // 3) MyMemory Ñ€ĞµĞ·ĞµÑ€Ğ²
    try {
      const pair = `${from === "auto" ? "auto" : from}|${to}`;
      const url = `${MYMEMORY_URL}?q=${encodeURIComponent(text)}&langpair=${encodeURIComponent(pair)}`;
      const r = await fetch(url);
      if (r.ok) {
        const data = await r.json();
        const t = data?.responseData?.translatedText;
        if (t) return t;
      }
    } catch (e) { console.warn("MyMemory error:", e); }

    // 4) fallback: Ğ¿Ğ¾Ğ²ĞµÑ€Ğ½ÑƒÑ‚Ğ¸ Ğ¾Ñ€Ğ¸Ğ³Ñ–Ğ½Ğ°Ğ»
    return text;
  }

  // ====== Ğ Ğ¾Ğ·Ğ¿Ñ–Ğ·Ğ½Ğ°Ğ²Ğ°Ğ½Ğ½Ñ Ğ¼Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ ======
  let recognition = null;
  let listening = false;

  function setupRecognition() {
    if (!asrSupported) {
      statusEl.textContent = "Ğ’Ğ°Ñˆ Ğ±Ñ€Ğ°ÑƒĞ·ĞµÑ€ Ğ½Ğµ Ğ¿Ñ–Ğ´Ñ‚Ñ€Ğ¸Ğ¼ÑƒÑ” Web Speech API. Ğ’Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ°Ğ¹Ñ‚Ğµ Chrome/Edge.";
      return;
    }
    recognition = new SR();
    recognition.lang = sourceSel.value;
    recognition.continuous = true;
    recognition.interimResults = false;

    recognition.onstart = () => { statusEl.textContent = "ğŸ§ Ğ¡Ğ»ÑƒÑ…Ğ°Ñâ€¦ Ğ“Ğ¾Ğ²Ğ¾Ñ€Ñ–Ñ‚ÑŒ."; };
    recognition.onerror = (e) => { statusEl.textContent = "ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ñ€Ğ¾Ğ·Ğ¿Ñ–Ğ·Ğ½Ğ°Ğ²Ğ°Ğ½Ğ½Ñ: " + e.error; };
    recognition.onend = () => {
      if (listening) { recognition.start(); } else { statusEl.textContent = "Ğ—ÑƒĞ¿Ğ¸Ğ½ĞµĞ½Ğ¾."; }
    };
    recognition.onresult = async (ev) => {
      const res = ev.results[ev.results.length - 1];
      if (!res || !res.isFinal) return;
      const text = res[0].transcript.trim();
      if (!text) return;

      orig.value += (orig.value ? "\n" : "") + text;

      // Ğ³Ğ¾Ğ»Ğ¾ÑĞ¾Ğ²Ğ° ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° Ğ´Ğ»Ñ Ğ·ÑƒĞ¿Ğ¸Ğ½ĞºĞ¸
      if (["ÑÑ‚Ğ¾Ğ¿","stop","Ğ·ÑƒĞ¿Ğ¸Ğ½Ğ¸ÑÑŒ"].includes(text.toLowerCase())) { stop(); return; }

      statusEl.textContent = "ĞŸĞµÑ€ĞµĞºĞ»Ğ°Ğ´Ğ°Ñâ€¦";
      const translated = await translateText(text, targetSel.value, shortLang(sourceSel.value));
      tran.value  += (tran.value ? "\n" : "") + translated;
      statusEl.textContent = "âœ… Ğ”Ğ¾Ğ´Ğ°Ğ½Ğ¾ Ñ„Ñ€Ğ°Ğ³Ğ¼ĞµĞ½Ñ‚";
    };
  }

  function start() {
    if (!recognition) setupRecognition();
    if (!recognition) return;
    listening = true;
    recognition.lang = sourceSel.value;
    try { recognition.start(); startBtn.disabled = true; stopBtn.disabled = false; } catch {}
  }
  function stop() {
    listening = false;
    if (recognition) { try { recognition.stop(); } catch {} }
    startBtn.disabled = false; stopBtn.disabled = true;
  }

  // ====== Word (.docx) ======
  async function saveDocx() {
    const { Document, Packer, Paragraph, HeadingLevel } = window.docx;
    const doc = new Document({
      sections: [{
        properties: {},
        children: [
          new Paragraph({ text: "Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ Ñ€Ğ¾Ğ·Ğ¿Ñ–Ğ·Ğ½Ğ°Ğ²Ğ°Ğ½Ğ½Ñ", heading: HeadingLevel.TITLE }),
          new Paragraph({ text: "" }),
          new Paragraph({ text: "ĞÑ€Ğ¸Ğ³Ñ–Ğ½Ğ°Ğ»", heading: HeadingLevel.HEADING_2 }),
          new Paragraph({ text: orig.value || "" }),
          new Paragraph({ text: "" }),
          new Paragraph({ text: "ĞŸĞµÑ€ĞµĞºĞ»Ğ°Ğ´", heading: HeadingLevel.HEADING_2 }),
          new Paragraph({ text: tran.value || "" }),
        ],
      }]
    });
    const blob = await Packer.toBlob(doc);
    const ts = new Date().toISOString().slice(0,19).replace(/[:T]/g,"-");
    saveAs(blob, `voice_to_text_${ts}.docx`);
  }

  // ====== ĞšĞ¾Ğ¿Ñ–ÑĞ²Ğ°Ğ½Ğ½Ñ Ğ¿ĞµÑ€ĞµĞºĞ»Ğ°Ğ´Ñƒ + TXT ======
  async function copyTranslation() {
    const text = tran.value || "";
    if (!text.trim()) { statusEl.textContent = "ĞĞµĞ¼Ğ°Ñ” Ğ¿ĞµÑ€ĞµĞºĞ»Ğ°Ğ´Ñƒ Ğ´Ğ»Ñ ĞºĞ¾Ğ¿Ñ–ÑĞ²Ğ°Ğ½Ğ½Ñ"; return; }
    try {
      await navigator.clipboard.writeText(text);
      statusEl.textContent = "ğŸ“‹ ĞŸĞµÑ€ĞµĞºĞ»Ğ°Ğ´ ÑĞºĞ¾Ğ¿Ñ–Ğ¹Ğ¾Ğ²Ğ°Ğ½Ğ¾";
    } catch {
      // fallback
      const ta = document.createElement("textarea");
      ta.value = text; document.body.appendChild(ta); ta.select();
      try { document.execCommand("copy"); statusEl.textContent = "ğŸ“‹ ĞŸĞµÑ€ĞµĞºĞ»Ğ°Ğ´ ÑĞºĞ¾Ğ¿Ñ–Ğ¹Ğ¾Ğ²Ğ°Ğ½Ğ¾"; }
      catch { statusEl.textContent = "ĞĞµ Ğ²Ğ´Ğ°Ğ»Ğ¾ÑÑ ÑĞºĞ¾Ğ¿Ñ–ÑĞ²Ğ°Ñ‚Ğ¸"; }
      finally { document.body.removeChild(ta); }
    }
  }

  function exportTxt() {
    const content =
`=== ĞĞ Ğ˜Ğ“Ğ†ĞĞĞ› ===
${orig.value || ""}

=== ĞŸĞ•Ğ Ğ•ĞšĞ›ĞĞ” ===
${tran.value || ""}
`;
    const blob = new Blob([content], {type:"text/plain;charset=utf-8"});
    const ts = new Date().toISOString().slice(0,19).replace(/[:T]/g,"-");
    saveAs(blob, `voice_to_text_${ts}.txt`);
  }

  // ====== ĞŸÑ€Ğ¸Ğ²'ÑĞ·ĞºĞ° Ğ¿Ğ¾Ğ´Ñ–Ğ¹ ======
  startBtn.addEventListener("click", start);
  stopBtn .addEventListener("click", stop);
  clearBtn.addEventListener("click", () => { orig.value=""; tran.value=""; statusEl.textContent="ĞÑ‡Ğ¸Ñ‰ĞµĞ½Ğ¾"; });
  saveBtn .addEventListener("click", saveDocx);
  copyBtn .addEventListener("click", copyTranslation);
  txtBtn  .addEventListener("click", exportTxt);
  sourceSel.addEventListener("change", () => { if (recognition) recognition.lang = sourceSel.value; });

  // init
  setupRecognition();
})();
</script>
</body>
</html>
