<!DOCTYPE html>
<html lang="uk" data-theme="dark">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Voice ‚Üí Translate ‚Üí Word</title>
<link rel="preconnect" href="https://unpkg.com">
<style>
  :root{
    --bg:#0b1020; --text:#e5e7eb; --muted:#94a3b8;
    --panel:#0f172a; --card:#111827; --line:rgba(255,255,255,.08);
    --btn:#1f2937; --primary:#2563eb; --danger:#ef4444; --accent:#22c55e;
    --pane-text:#e5e7eb; --pane-alt:#eef9ff;
  }
  [data-theme="light"]{
    --bg:#f8fafc; --text:#0f172a; --muted:#475569;
    --panel:#ffffff; --card:#ffffff; --line:rgba(0,0,0,.1);
    --btn:#e2e8f0; --primary:#2563eb; --danger:#ef4444; --accent:#16a34a;
    --pane-text:#0f172a; --pane-alt:#e6f4ff;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
  .wrap{max-width:1100px;margin:32px auto;padding:0 16px}
  .bar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:16px}
  .btn{appearance:none;border:0;border-radius:12px;padding:12px 16px;background:var(--btn);color:var(--text);cursor:pointer}
  .btn:hover{filter:brightness(1.05)} .btn:disabled{opacity:.5;cursor:not-allowed}
  .btn.primary{background:var(--primary);color:#fff} .btn.stop{background:var(--danger);color:#fff}
  .btn.ghost{background:transparent;border:1px solid var(--line)}
  .select{padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:var(--panel);color:var(--text)}
  .pane{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:14px}
  textarea{width:100%;min-height:200px;background:transparent;border:0;color:var(--pane-text);resize:vertical;font-size:15px;line-height:1.5}
  h1{font-size:22px;margin:0 0 14px 0} h2{font-size:16px;margin:10px 0}
  .status{margin-top:6px;font-size:13px;color:var(--muted)}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:20px;background:var(--panel);border:1px solid var(--line);font-size:12px}
  .ok{color:var(--accent)} .bad{color:var(--danger)}
  .spacer{flex:1}
</style>
</head>
<body>
<div class="wrap">
  <h1>üéôÔ∏è Voice ‚Üí üåç Translate ‚Üí üìÑ Word</h1>

  <div class="bar">
    <button id="startBtn" class="btn primary" aria-label="–ü–æ—á–∞—Ç–∏">‚ñ∂Ô∏è –ü–æ—á–∞—Ç–∏</button>
    <button id="stopBtn" class="btn stop" disabled aria-label="–ó—É–ø–∏–Ω–∏—Ç–∏">‚èπ –ó—É–ø–∏–Ω–∏—Ç–∏</button>
    <button id="clearBtn" class="btn" aria-label="–û—á–∏—Å—Ç–∏—Ç–∏">üßπ –û—á–∏—Å—Ç–∏—Ç–∏</button>
    <button id="saveBtn" class="btn" aria-label="–ó–±–µ—Ä–µ–≥—Ç–∏ –≤ Word">üíæ Word</button>
    <button id="copyBtn" class="btn" aria-label="–ö–æ–ø—ñ—é–≤–∞—Ç–∏ –ø–µ—Ä–µ–∫–ª–∞–¥">üìã –ö–æ–ø—ñ—é–≤–∞—Ç–∏</button>
    <button id="txtBtn" class="btn" aria-label="–ï–∫—Å–ø–æ—Ä—Ç —É TXT">üóí TXT</button>
    <span class="spacer"></span>
    <button id="themeBtn" class="btn ghost" aria-label="–ü–µ—Ä–µ–º–∫–Ω—É—Ç–∏ —Ç–µ–º—É">üåô –¢–µ–º–∞</button>
  </div>

  <div class="bar">
    <label>üó£ –ú–æ–≤–∞ –¥–∏–∫—Ç–æ—Ä–∞:
      <select id="sourceLang" class="select">
        <option value="uk-UA">uk-UA (–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞)</option>
        <option value="ru-RU">ru-RU (–†—É—Å—Å–∫–∏–π)</option>
        <option value="en-US">en-US (English)</option>
        <option value="pl-PL">pl-PL (Polski)</option>
        <option value="de-DE">de-DE (Deutsch)</option>
        <option value="fr-FR">fr-FR (Fran√ßais)</option>
      </select>
    </label>
    <label>üîΩ –ú–æ–≤–∞ –ø–µ—Ä–µ–∫–ª–∞–¥—É:
      <select id="targetLang" class="select">
        <option value="uk">uk</option>
        <option value="en">en</option>
        <option value="pl">pl</option>
        <option value="de">de</option>
        <option value="fr">fr</option>
        <option value="es">es</option>
      </select>
    </label>
    <span class="pill" id="asrSupport">ASR: ‚Ä¶</span>
    <span class="pill" id="transSupport">Translate: ‚Ä¶</span>
  </div>

  <div class="pane">
    <h2>üé§ –û—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–∏–π —Ç–µ–∫—Å—Ç</h2>
    <textarea id="orig" placeholder="–¢—É—Ç –∑‚Äô—è–≤–ª—è—Ç–∏–º–µ—Ç—å—Å—è —Ä–æ–∑–ø—ñ–∑–Ω–∞–Ω–∏–π —Ç–µ–∫—Å—Ç‚Ä¶"></textarea>
  </div>

  <div class="pane" style="margin-top:14px;">
    <h2>üåç –ü–µ—Ä–µ–∫–ª–∞–¥</h2>
    <textarea id="tran" placeholder="–¢—É—Ç –∑‚Äô—è–≤–ª—è—Ç–∏–º–µ—Ç—å—Å—è –ø–µ—Ä–µ–∫–ª–∞–¥‚Ä¶"></textarea>
    <div class="status" id="status">–ì–æ—Ç–æ–≤–æ –¥–æ —Ä–æ–±–æ—Ç–∏</div>
  </div>
</div>

<script src="https://unpkg.com/docx@8.5.0/build/index.umd.js"></script>
<script src="https://unpkg.com/file-saver@2.0.5/dist/FileSaver.min.js"></script>
<script>
(() => {
  // ===== CONFIG: Translator =====
  const AZURE_KEY = "";          // ‚Üê –≤—Å—Ç–∞–≤ –∫–ª—é—á (–æ–ø—Ü—ñ–π–Ω–æ)
  const AZURE_REGION = "";       // ‚Üê –Ω–∞–ø—Ä. "westeurope"
  const AZURE_ENDPOINT = "https://api.cognitive.microsofttranslator.com/translate?api-version=3.0";

  // Fallbacks (–±–µ–∑ –∫–ª—é—á—ñ–≤)
  const LIBRE_URLS = [
    "https://libretranslate.com/translate",
    "https://libretranslate.de/translate",
    "https://translate.astian.org/translate"
  ];
  const MYMEMORY_URL = "https://api.mymemory.translated.net/get";

  const shortLang = (code) => (code || "").split("-")[0].toLowerCase();

  // ===== UI refs =====
  const startBtn = document.getElementById("startBtn");
  const stopBtn  = document.getElementById("stopBtn");
  const clearBtn = document.getElementById("clearBtn");
  const saveBtn  = document.getElementById("saveBtn");
  const copyBtn  = document.getElementById("copyBtn");
  const txtBtn   = document.getElementById("txtBtn");
  const themeBtn = document.getElementById("themeBtn");

  const sourceSel= document.getElementById("sourceLang");
  const targetSel= document.getElementById("targetLang");
  const orig     = document.getElementById("orig");
  const tran     = document.getElementById("tran");
  const statusEl = document.getElementById("status");
  const asrBadge = document.getElementById("asrSupport");
  const trBadge  = document.getElementById("transSupport");

  // ===== Theme toggle =====
  const root = document.documentElement;
  const savedTheme = localStorage.getItem("theme");
  if (savedTheme) root.setAttribute("data-theme", savedTheme);
  themeBtn.textContent = (root.getAttribute("data-theme")==="dark") ? "üåô –¢–µ–º–∞" : "‚òÄÔ∏è –¢–µ–º–∞";
  themeBtn.addEventListener("click", () => {
    const cur = root.getAttribute("data-theme") || "dark";
    const next = cur === "dark" ? "light" : "dark";
    root.setAttribute("data-theme", next);
    localStorage.setItem("theme", next);
    themeBtn.textContent = next==="dark" ? "üåô –¢–µ–º–∞" : "‚òÄÔ∏è –¢–µ–º–∞";
  });

  // Default target = system language (if present)
  const sys = (navigator.language || "uk").split("-")[0];
  [...targetSel.options].some(o => { if (o.value === sys) { targetSel.value = sys; return true; } });

  // ===== ASR support badge =====
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  const asrSupported = !!SR;
  asrBadge.textContent = "ASR: " + (asrSupported ? "supported" : "not available");
  asrBadge.classList.add(asrSupported ? "ok" : "bad");
  trBadge.textContent = "Translate: " + (AZURE_KEY && AZURE_REGION ? "Azure" : "Libre + backup");
  trBadge.classList.add("ok");

  // ===== Translator with early return for equal languages =====
  async function translateText(text, to, from = "auto") {
    if (!text.trim()) return "";
    if (to && from && shortLang(to) === shortLang(from)) {
      // –æ–¥–Ω–∞–∫–æ–≤—ñ –º–æ–≤–∏ ‚Äî –ø–µ—Ä–µ–∫–ª–∞–¥ –Ω–µ –ø–æ—Ç—Ä—ñ–±–µ–Ω
      return text;
    }

    // 1) Azure (if configured)
    if (AZURE_KEY && AZURE_REGION) {
      try {
        const url = `${AZURE_ENDPOINT}&to=${encodeURIComponent(to)}`;
        const r = await fetch(url, {
          method: "POST",
          headers: {
            "Ocp-Apim-Subscription-Key": AZURE_KEY,
            "Ocp-Apim-Subscription-Region": AZURE_REGION,
            "Content-Type": "application/json; charset=UTF-8",
          },
          body: JSON.stringify([{ Text: text }])
        });
        if (r.ok) {
          const data = await r.json();
          const t = data?.[0]?.translations?.[0]?.text;
          if (t) return t;
        } else { console.warn("Azure HTTP:", r.status); }
      } catch (e) { console.warn("Azure error:", e); }
    }

    // 2) LibreTranslate mirrors
    for (const url of LIBRE_URLS) {
      try {
        const r = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ q: text, source: from, target: to, format: "text" })
        });
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        const data = await r.json();
        if (data?.translatedText) return data.translatedText;
      } catch (e) { console.warn("Libre error:", url, e); }
    }

    // 3) MyMemory backup
    try {
      const pair = `${from === "auto" ? "auto" : from}|${to}`;
      const url = `${MYMEMORY_URL}?q=${encodeURIComponent(text)}&langpair=${encodeURIComponent(pair)}`;
      const r = await fetch(url);
      if (r.ok) {
        const data = await r.json();
        const t = data?.responseData?.translatedText;
        if (t) return t;
      }
    } catch (e) { console.warn("MyMemory error:", e); }

    // 4) fallback: return original text
    return text;
  }

  // ===== Speech Recognition =====
  let recognition = null;
  let listening = false;

  function setupRecognition() {
    if (!asrSupported) {
      statusEl.textContent = "–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î Web Speech API. –í–∏–∫–æ—Ä–∏—Å—Ç–∞–π—Ç–µ Chrome/Edge.";
      return;
    }
    recognition = new SR();
    recognition.lang = sourceSel.value;
    recognition.continuous = true;
    recognition.interimResults = false;

    recognition.onstart = () => { statusEl.textContent = "üéß –°–ª—É—Ö–∞—é‚Ä¶ –ì–æ–≤–æ—Ä—ñ—Ç—å."; };
    recognition.onerror = (e) => { statusEl.textContent = "–ü–æ–º–∏–ª–∫–∞ —Ä–æ–∑–ø—ñ–∑–Ω–∞–≤–∞–Ω–Ω—è: " + e.error; };
    recognition.onend = () => {
      if (listening) { recognition.start(); } else { statusEl.textContent = "–ó—É–ø–∏–Ω–µ–Ω–æ."; }
    };
    recognition.onresult = async (ev) => {
      const res = ev.results[ev.results.length - 1];
      if (!res || !res.isFinal) return;
      const text = res[0].transcript.trim();
      if (!text) return;

      orig.value += (orig.value ? "\n" : "") + text;

      // voice stop
      if (["—Å—Ç–æ–ø","stop","–∑—É–ø–∏–Ω–∏—Å—å"].includes(text.toLowerCase())) { stop(); return; }

      const srcShort = shortLang(sourceSel.value);
      // —è–∫—â–æ –º–æ–≤–∏ –æ–¥–Ω–∞–∫–æ–≤—ñ ‚Äî –ø—Ä–æ—Å—Ç–æ –∫–æ–ø—ñ—é—î–º–æ
      if (srcShort === shortLang(targetSel.value)) {
        tran.value += (tran.value ? "\n" : "") + text;
        statusEl.textContent = "‚è© –ú–æ–≤–∏ –æ–¥–Ω–∞–∫–æ–≤—ñ ‚Äî —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ –±–µ–∑ –ø–µ—Ä–µ–∫–ª–∞–¥—É";
        return;
      }

      statusEl.textContent = "–ü–µ—Ä–µ–∫–ª–∞–¥–∞—é‚Ä¶";
      const translated = await translateText(text, targetSel.value, srcShort);
      tran.value  += (tran.value ? "\n" : "") + translated;
      statusEl.textContent = "‚úÖ –î–æ–¥–∞–Ω–æ —Ñ—Ä–∞–≥–º–µ–Ω—Ç";
    };
  }

  function start() {
    if (!recognition) setupRecognition();
    if (!recognition) return;
    listening = true;
    recognition.lang = sourceSel.value;
    try { recognition.start(); startBtn.disabled = true; stopBtn.disabled = false; } catch {}
  }
  function stop() {
    listening = false;
    if (recognition) { try { recognition.stop(); } catch {} }
    startBtn.disabled = false; stopBtn.disabled = true;
  }

  // ===== Save DOCX =====
  async function saveDocx() {
    const { Document, Packer, Paragraph, HeadingLevel } = window.docx;
    const doc = new Document({
      sections: [{
        properties: {},
        children: [
          new Paragraph({ text: "–†–µ–∑—É–ª—å—Ç–∞—Ç —Ä–æ–∑–ø—ñ–∑–Ω–∞–≤–∞–Ω–Ω—è", heading: HeadingLevel.TITLE }),
          new Paragraph({ text: "" }),
          new Paragraph({ text: "–û—Ä–∏–≥—ñ–Ω–∞–ª", heading: HeadingLevel.HEADING_2 }),
          new Paragraph({ text: orig.value || "" }),
          new Paragraph({ text: "" }),
          new Paragraph({ text: "–ü–µ—Ä–µ–∫–ª–∞–¥", heading: HeadingLevel.HEADING_2 }),
          new Paragraph({ text: tran.value || "" }),
        ],
      }]
    });
    const blob = await Packer.toBlob(doc);
    const ts = new Date().toISOString().slice(0,19).replace(/[:T]/g,"-");
    saveAs(blob, `voice_to_text_${ts}.docx`);
  }

  // ===== Copy & TXT =====
  async function copyTranslation() {
    const text = tran.value || "";
    if (!text.trim()) { statusEl.textContent = "–ù–µ–º–∞—î –ø–µ—Ä–µ–∫–ª–∞–¥—É –¥–ª—è –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è"; return; }
    try {
      await navigator.clipboard.writeText(text);
      statusEl.textContent = "üìã –ü–µ—Ä–µ–∫–ª–∞–¥ —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ";
    } catch {
      const ta = document.createElement("textarea");
      ta.value = text; document.body.appendChild(ta); ta.select();
      try { document.execCommand("copy"); statusEl.textContent = "üìã –ü–µ—Ä–µ–∫–ª–∞–¥ —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ"; }
      catch { statusEl.textContent = "–ù–µ –≤–¥–∞–ª–æ—Å—è —Å–∫–æ–ø—ñ—é–≤–∞—Ç–∏"; }
      finally { document.body.removeChild(ta); }
    }
  }
  function exportTxt() {
    const content =
`=== –û–†–ò–ì–Ü–ù–ê–õ ===
${orig.value || ""}

=== –ü–ï–†–ï–ö–õ–ê–î ===
${tran.value || ""}
`;
    const blob = new Blob([content], {type:"text/plain;charset=utf-8"});
    const ts = new Date().toISOString().slice(0,19).replace(/[:T]/g,"-");
    saveAs(blob, `voice_to_text_${ts}.txt`);
  }

  // ===== Events =====
  startBtn.addEventListener("click", start);
  stopBtn .addEventListener("click", stop);
  clearBtn.addEventListener("click", () => { orig.value=""; tran.value=""; statusEl.textContent="–û—á–∏—â–µ–Ω–æ"; });
  saveBtn .addEventListener("click", saveDocx);
  copyBtn .addEventListener("click", copyTranslation);
  txtBtn  .addEventListener("click", exportTxt);
  sourceSel.addEventListener("change", () => { if (recognition) recognition.lang = sourceSel.value; });

  // init
  const trIsAzure = !!(AZURE_KEY && AZURE_REGION);
  trBadge.textContent = "Translate: " + (trIsAzure ? "Azure" : "Libre + backup");
  setupRecognition();
})();
</script>
</body>
</html>
